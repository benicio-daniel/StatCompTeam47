---
title: "Case Study 3: Visualization"
subtitle: "AKSTA Statistical Computing"
output: 
  html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

*The  .Rmd* **and** *.html (or .pdf) should be uploaded in TUWEL by the deadline. Refrain from using explanatory comments in the R code chunks but write them as text instead. Points will be deducted if the submitted file is not in a decent form.*

**DISCLAIMER**: In case students did not contribute equally, include a disclaimer stating what each student's contribution was.


 
# Data

Load the data set you exported in the final Task of Case Study 2. 
Eliminate all observations with missing values in the income status variable.

```{r setup-import, message=FALSE}
# Load necessary libraries
library(tidyverse)
library(ggplot2)
library(readr)
library(dplyr)

# Load dataset from the data folder
data <- read_csv("data/file_out2.csv")
```

````{r load data}
# View the dimension and first few rows
dim(data)
head(data)

# View column names
colnames(data)
```

As a reminder, the data set includes world data from 2020, focusing on:

- **Education Expenditure (% of GDP)**
- **Youth Unemployment Rate (15-24 years)**
- **Net Migration Rate** (difference between the number of people entering and leaving a country per 1,000 persons)

for most world entities in 2020. The data was downloaded from https://www.cia.gov/the-world-factbook/about/archives/.
Additional information on continent, subcontinent/region and income status was appended 
to the dataset in Case Study 2.

# Tasks:


## a. Education expenditure in different income levels

Using **ggplot2**, create a density plot of the education expenditure grouped by income 
status. The densities for the different groups are superimposed in the 
same plot rather than in different plots. Ensure that you order the levels of the 
income status such that in the plots the legend is ordered from High (H) to Low (L).

  * The color of the density lines is black.
  
  * The area under the density curve should be colored differently among the income status levels.
  
  * For the colors, choose a transparency level of 0.5 for better visibility.
  
  * Position the legend at the top center of the plot and give it no title (hint: use `element_blank()`).
  
  * Rename the x axis as "Education expenditure (% of GDP)"
  
```{r density plot of the education expenditure, warning=FALSE}
# Recode status
data$income_status <- recode(data$status,
                             "H" = "High",
                             "UM" = "Upper middle",
                             "LM" = "Lower middle",
                             "L" = "Low")

# Clean expenditure
data$expenditure[data$expenditure == "."] <- NA
data$expenditure <- as.numeric(data$expenditure)

# Factor levels in correct order
data$income_status <- factor(data$income_status,
                             levels = c("High", "Upper middle", "Lower middle", "Low"))

# Filter valid data (remove NAs in both variables)
data_clean <- data %>%
  filter(!is.na(expenditure), !is.na(income_status))

# Plot
ggplot(data_clean, aes(x = expenditure, fill = income_status)) +
  geom_density(alpha = 0.5, color = "black") +
  labs(x = "Education expenditure (% of GDP)", y = "Density", fill = NULL) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    legend.justification = "center"
  )
```
  
Comment briefly on the plot:

The plot shows the distribution of education expenditure (as a percentage of GDP) across four income groups: High, Upper middle, Lower middle, and Low. Each group's density curve is distinct, with:

- Low-income countries having a broader and lower-spending distribution, peaking around 2–3%.
- High and upper-middle income countries clustering more tightly between 4–6%.
- Lower-middle income countries show a more spread-out distribution, with some countries spending over 10%.
- This suggests that low-income countries tend to allocate a smaller share of GDP to education, though there's significant variation across all groups. 


## b. Income status in different continents

Investigate how the income status is distributed in the different continents. 

* Using **ggplot2**, create a stacked barplot of absolute frequencies showing how the entities are split into continents and income status.
````{r stacked barplot of absolute frequencies}
# Filter out rows with missing income status (NA values)
data_filtered <- subset(data, !is.na(income_status))

# Create a stacked barplot of absolute frequencies by continent and income status
ggplot(data_filtered, aes(x = continent, fill = income_status)) +
  geom_bar(position = "stack") +
  labs(title = "Income Status Distribution Across Continents",
       x = "Continent",
       y = "Number of Entities",
       fill = "Income Status") +
  theme_minimal()

```
Comment the plot:

The plot shows that income status is unevenly distributed across continents by displaying how many countries from each income group exist per continent. It highlights that Africa has the most low- and lower-middle-income countries, while Europe and the Americas include more high-income countries, reflecting global economic disparities.


* Create another stacked barplot of relative frequencies (height of the bars should be one).
```{r stacked barplot of relative frequencie}

# Create a stacked barplot of relative frequencies (proportions) by continent and income status
ggplot(data_filtered, aes(x = continent, fill = income_status)) +
  geom_bar(position = "fill") +
  labs(title = "Relative Income Status Distribution Across Continents",
       x = "Continent",
       y = "Proportion",
       fill = "Income Status") +
  theme_minimal()

```

Comment the plot:

This plot shows the proportion of each income group within every continent. It reveals that Africa has a high internal share of low-income countries, while Europe and Oceania are mostly composed of high-income entities, highlighting differences in internal economic composition.


* Create a mosaic plot of continents and income status using base R functions.
````{r mosaic plot}

# Create a mosaic plot of continent and income status using base R
mosaicplot(~ continent + income_status, data = data_filtered, color = TRUE,
           main = "Mosaic Plot of Income Status by Continent",
           xlab = "Continent", ylab = "Income Status", las = 1)  # las=1 makes labels horizontal
````

* Briefly comment on the differences between the three plots generated to investigate the income 
distribution among the different continents:

The stacked barplot of absolute frequencies shows how many entities from each income group exist per continent, making it easy to compare total counts but harder to compare internal proportions. The relative stacked barplot standardizes the height of bars, allowing clearer comparison of income distribution within each continent, independent of how many countries each has. The mosaic plot combines both aspects: bar width reflects the number of countries per continent, while segment height shows the income breakdown, offering a compact overview of both size and structure.

Africa has the highest number and internal share of low- and lower-middle-income countries, while Europe and the Americas are dominated by high-income entities. Asia shows a more balanced distribution across all income categories, and Oceania is primarily composed of high- and upper-middle-income countries. These visualizations highlight both the unequal distribution of income status between continents and differences in their internal income structures.


## c. Income status in different subcontinents

For Oceania, investigate further how the income status distribution is in the different subcontinents.
Use one of the plots in b. for this purpose. 
```{r Oceania plot}
# Filter for Oceania only
oceania_data <- data_filtered %>% filter(continent == "Oceania")

# Plot income distribution by subregion within Oceania
ggplot(oceania_data, aes(x = subcontinent, fill = income_status)) +
  geom_bar(position = "fill") +
  labs(title = "Relative Income Status Distribution in Oceania Subregions",
       x = "Subregion", y = "Proportion", fill = "Income Status") +
  theme_minimal()
```

Comment on the results:

The plot shows clear differences in income status across Oceania’s subregions, based on the countries classified within them. Australia and New Zealand consist entirely of high-income countries, while Melanesia mainly includes lower-middle-income countries. Polynesia is dominated by upper-middle-income countries. Micronesia shows a more balanced distribution across high- and lower-middle-income levels, with only a small share in the upper-middle-income group. Notably, no countries in Oceania are classified as low-income. This highlights economic variation between subregions, with wealth concentrated in the southern part of Oceania and more diverse income levels across the island regions.


## d. Net migration in different continents

* Using **ggplot2**, create parallel boxplots  showing  the distribution of the
net migration rate in the different continents.
```{r parallel boxplots}
ggplot(data_filtered, aes(x = continent, y = net_migr_rate)) +
  geom_boxplot()
```

* Prettify the plot (change y-, x-axis labels, etc).
```{r prettified parallel boxplots}
ggplot(data_filtered, aes(x = continent, y = net_migr_rate, fill = continent)) +
  geom_boxplot(outlier.shape = NA, color = "black") +  # Outliers hidden, but data still used
  coord_cartesian(ylim = c(-20, 20)) +  # Focus on main distribution
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Net Migration Rate by Continent",
    x = "Continent",
    y = "Net Migration Rate (per 1,000 population)",
    fill = "Continent"
  ) +
  theme_minimal(base_size = 13)
```

* Identify which country in Asia constitutes the largest negative outlier and 
which country in Asia constitutes the largest positive outlier.
```{r Identifying Asian outliers}
# Filter Asian countries with valid net migration data
asia_data <- data_filtered %>%
  filter(continent == "Asia", !is.na(net_migr_rate))

# Identify largest positive outlier
asia_data %>%
  filter(net_migr_rate == max(net_migr_rate))

# Identify largest negative outlier
asia_data %>%
  filter(net_migr_rate == min(net_migr_rate))
```

* Comment on the plot.

First, a standard boxplot was created to visualize the distribution of net migration rates across continents. It revealed the presence of strong outliers, especially in Asia. In a second step, the plot was improved by adjusting axis labels, coloring the boxes by continent, hiding outliers for clarity, and limiting the y-axis range to focus on the main distribution. Finally, the most extreme outliers in Asia were identified: Lebanon with the most negative net migration rate and Syria with the highest positive rate.


## e. Net migration in different subcontinents

The graph in d. clearly does not convey the whole picture. It would be interesting also 
to look at the subcontinents, as it is likely that a lot of migration flows
happen within the continent.

* Investigate the net migration in different subcontinents
using again parallel boxplots. Group the boxplots by continent (hint: use `facet_grid` with `scales = "free_x"`).
```{r grouped boxplots}
ggplot(data_filtered, aes(x = subcontinent, y = net_migr_rate)) +
  geom_boxplot() +
  facet_grid(. ~ continent, scales = "free_x")
```

* Remember to prettify the plot (rotate axis labels if needed).
```{r prettified grouped boxplots}
ggplot(data_filtered, aes(x = subcontinent, y = net_migr_rate)) +
  geom_boxplot(fill = "skyblue", color = "black", outlier.color = "red") +
  facet_grid(. ~ continent, scales = "free_x", space = "free_x") +
  labs(
    title = "Net Migration Rate by Subcontinent",
    x = "Subcontinent",
    y = "Net Migration Rate (per 1,000 population)"
  ) +
  coord_cartesian(ylim = c(-20, 20)) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

* Describe what you see.

The plot reveals clear differences in net migration rates across subcontinents. Northern America and Western Europe show consistently high net migration rates, while regions such as Melanesia, Micronesia, and Western Asia tend to have more negative values. Notably, the Caribbean and Sub-Saharan Africa show a large number of outliers in both directions, suggesting strong variability or unstable migration patterns within those subregions.

While the cleaned-up version of the plot with limited y-axis and hidden outliers offers a clearer overview of general patterns, it also masks extreme individual cases. This highlights that polished graphics can improve readability but may hide important details, and should therefore be interpreted with care.


## f. Median net migration rate per subcontinent.

The plot in task e. shows the distribution of the net migration rate for each 
subcontinent. Here you will work on visualizing only one summary statistic, namely 
the median. 

For each subcontinent, calculate the median net migration rate. Then create a plot which
contains the sub-regions on the y-axis and the median net migration rate on 
the x-axis. 

  * As geoms use points. 
  
  *  Color the points by continent -- use a colorblind friendly palette (see e.g., 
  [here](http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/)).
  
  * Rename the axes.
  
  * Using `fct_reorder` from the **forcats** package, arrange the levels of subcontinent
  such that in the plot the lowest (bottom) subcontinent contains the lowest median
  net migration
  rate and the upper most region contains the highest median
  net migration
  rate.
  
  * Comment on the plot. E.g., what are the regions with the most influx? 
  What are the regions with the most outflux?


## g. Median youth unemployment rate per subcontinent

For each subcontinent, calculate the median youth unemployment rate. Then create a plot which
contains the sub-regions on the y-axis and the median unemployment rate on 
the x-axis. 

  * Use a black and white theme (`?theme_bw()`)
  
  * As geoms use bars. (hint: pay attention to the statistical transformation taking place
  in `geom_bar()` -- look into  argument `stat="identity"`) 
  
  * Color the bars by continent -- use a colorblind friendly palette.
  
  * Make the bars transparent (use `alpha = 0.7`).
  
  * Rename the axes.
  
  * Using `fct_reorder` from the **forcats** package, arrange the levels of subcontinent
  such that in the plot the lowest (bottom) subcontinent contains the lowest median
  youth unemployment rate and the upper most region contains the highest median
  youth unemployment rate.
  
  * Comment on the plot. E.g., what are the regions with the highest vs lowest youth
  unemployment rate?
  
## h. Median youth unemployment rate per subcontinent -- with error bars

The value displayed in the barplot in g. is the result of an aggregation, 
so it might be useful to also plot error bars, to have a general idea on
how precise the median unemployment is. This can be achieved by plotting the
error bars which reflect the standard deviation or the interquartile range of 
the variable in each of the subcontinents. 

Repeat the plot from Task g. but include also error bars which reflect the 25% and 75%
quantiles. You can use `geom_errorbar` in **ggplot2**.



## i. Relationship between education expenditure and net migration rate

Using **ggplot2**, create a plot showing the relationship between education expenditure and
net migration rate. 

  * Color the geoms based on the income status. 

  * Add a regression line for each development status (using `geom_smooth()`).
  
Comment on the plot. Do you see any relationship between the two variables? Do you see
any difference among the income levels?

## j. Relationship between youth unemployment and net migration rate

Create a plot as in Task i. but for youth unemployment and net migration rate. Comment briefly.

## k. Merging population data

Go online and find a data set which contains the 2020 population for the countries of the world
together with ISO codes. 

* Download this data and merge it to the dataset you are working on in
this case study using a left join.
(A possible source: [World Bank](https://data.worldbank.org/indicator/SP.POP.TOTL?end=2020&start=2020)))

* Inspect the data and check whether the join worked well.


## l. Scatterplot of education expenditure and net migration rate in Europe 

Make a scatterplot of education expenditure and net migration rate for the countries of Europe. 

  * Scale the size of the points according to each country's population. 
 
  * For better visibility, use a transparency of `alpha=0.7`. 
  
  * Remove the legend.
  
  * Comment on the plot.

## m. Interactive plot

On the merged data set from Task k., using function `ggplotly` from package **plotly**  
re-create the scatterplot in Task l., but this time for all countries. Color the points
according to their continent.

When hovering over the points the name of the country, 
the values for education expenditure, net migration rate, and population 
should be shown. (Hint: use the aesthetic `text = Country`. 
In `ggplotly` use the argument `tooltip = c("text", "x", "y", "size")`).



## n. Parallel coordinate plot

In **parallel coordinate plots** each observation or data point is depicted as a line 
traversing a series of parallel axes, corresponding to a specific variable or dimension.
It is often used for identifying clusters in the data.

One can create such a plot using the **GGally** R package. You should create 
such a plot where you look at the three main variables in the data set: 
education expenditure, youth unemployment rate and net migration rate. 
Color the lines based on the income status. Briefly comment.


## o. World map visualisation

Create a world map of the education expenditure per country.
You can use the vignette https://cran.r-project.org/web/packages/rworldmap/vignettes/rworldmap.pdf
to find how to do this in R. Alternatively, you can use other packages (such as **ggplot2**, **sf** and **rnaturalearthdata**) to create a map.
